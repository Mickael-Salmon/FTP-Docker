version: '3.8'

services:
  site1:
    build:
      context: ./site1
    container_name: site1
    networks:
      - web_network
      - internal_network
    ports:
      - "80:80"
      - "443:443"
      - "5501:5501"
      - "5502:5502"
    volumes:
      - ./logs/apache2/site1:/usr/local/apache2/logs
      - ./site1/www:/usr/local/apache2/htdocs
      - ./site1/sites-enabled/httpd.conf:/usr/local/apache2/conf/httpd.conf
      - ./site1/sites-enabled/httpd-vhosts.conf:/usr/local/apache2/conf/extra/httpd-vhosts.conf
      - ./site1/ssl:/usr/local/apache2/conf/ssl

  ftps:
    build: ./ftps
    container_name: ftps_server
    networks:
      - internal_network
    ports:
      - "21:21"
      - "30000-30009:30000-30009"
    environment:
      ADDED_FLAGS: "--tls=1"
      PUBLICHOST: "150.10.0.2"
    volumes:
      - ./site1/www:/home/ftpusers
      - ./logs/pure-ftpd:/var/log/pure-ftpd
      - ./certs:/etc/ssl/private

  sftp:
    build: ./sftp
    container_name: sftp_server
    networks:
      - internal_network
    ports:
      - "22:22"
    environment:
      - SFTP_USERS=dev_user:password:1001:1001::/var/www/extranet.rainbowbank.com:/bin/bash,design_user:password:1002:1002::/var/www/extranet.rainbowbank.com/images:/bin/bash
    volumes:
      - ./site1/www:/var/www
      - ./logs/sftp:/var/log/sftp

  fail2ban:
    build: ./fail2ban
    container_name: fail2ban
    networks:
      - internal_network
      - web_network
    volumes:
      - ./logs/apache2/site1:/var/log/apache2/site1
      - ./logs/apache2/site2:/var/log/apache2/site2
      - ./logs/pure-ftpd:/var/log/pure-ftpd
      - ./logs/auth.log:/var/log/auth.log

networks:
  web_network:
    driver: bridge
    ipam:
      config:
        - subnet: 150.10.0.0/16
  internal_network:
    driver: bridge
    ipam:
      config:
        - subnet: 192.168.10.0/24
